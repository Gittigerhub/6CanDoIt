<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/memberlayout}">

<head>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- Include Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>결제 취소</title>
    <!-- CSRF 토큰 -->
    <meta name="_csrf" th:content="${_csrf?.token}" />
    <meta name="_csrf_header" th:content="${_csrf?.headerName}" />
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
<div layout:fragment="content" class="p-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-danger text-white">
                    <h4 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>결제 취소</h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning" th:if="${paymentDTO.orderId != null && paymentDTO.orderId.startsWith('ROOM_')}">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <strong>주의!</strong> 결제를 취소하시면 예약도 함께 취소됩니다.
                    </div>

                    <div class="payment-details mt-4">
                        <h5 class="mb-3">결제 정보</h5>
                        <table class="table table-bordered">
                            <tr>
                                <th class="table-light" style="width: 150px;">주문 번호</th>
                                <td th:text="${paymentDTO.orderId}">ORDER_123</td>
                            </tr>
                            <tr>
                                <th class="table-light">결제 금액</th>
                                <td>
                                    <span class="text-primary fw-bold" th:text="${#numbers.formatInteger(paymentDTO.paymentPrice, 0, 'COMMA') + '원'}">100,000원</span>
                                </td>
                            </tr>
                            <tr>
                                <th class="table-light">결제 상태</th>
                                <td>
                                    <span class="badge bg-success" th:if="${paymentDTO.paymentState == 'Y'}">결제 완료</span>
                                    <span class="badge bg-danger" th:if="${paymentDTO.paymentState == 'N'}">결제 실패</span>
                                    <span class="badge bg-secondary" th:if="${paymentDTO.paymentState == 'CANCELLED'}">취소됨</span>
                                </td>
                            </tr>
                            <tr>
                                <th class="table-light">결제 일시</th>
                                <td th:text="${#temporals.format(paymentDTO.regDate, 'yyyy-MM-dd HH:mm:ss')}">2024-03-21 14:30:00</td>
                            </tr>
                        </table>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button type="button" class="btn btn-danger" onclick="confirmCancel()">
                            <i class="fas fa-ban me-2"></i>결제 취소하기
                        </button>
                        <a href="/res/list" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>목록으로 돌아가기
                        </a>
                        <!-- 예약 취소 후 결제 취소 페이지로 이동하는 버튼 추가 -->
                        <a href="/orders/payment/cancel/${paymentDTO.idx}" class="btn btn-warning mt-2">
                            <i class="fas fa-exclamation-circle me-2"></i>결제 취소 페이지로 이동
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="script">
    <script th:inline="javascript">
        /*<![CDATA[*/
        const csrfToken = $("meta[name='_csrf']").attr("content");
        const csrfHeader = $("meta[name='_csrf_header']").attr("content");
        const paymentIdx = /*[[${paymentDTO.idx}]]*/ null;
        const orderId = /*[[${paymentDTO.orderId}]]*/ '';

        function confirmCancel() {
            if (!paymentIdx) {
                Swal.fire({
                    icon: 'error',
                    title: '오류',
                    text: '결제 정보를 찾을 수 없습니다.',
                    confirmButtonText: '확인'
                });
                return;
            }

            let warningText = "취소된 결제는 복구할 수 없습니다.";
            if (orderId && orderId.startsWith('ROOM_')) {
                warningText += "\n예약도 함께 취소됩니다.";
            }

            Swal.fire({
                title: '결제 취소 확인',
                html: warningText.replace('\n', '<br>'),
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '결제 취소',
                cancelButtonText: '돌아가기',
                allowOutsideClick: false
            }).then((result) => {
                if (result.isConfirmed) {
                    cancelPayment();
                }
            });
        }

        function cancelPayment() {
            const headers = {};
            if (csrfHeader && csrfToken) {
                headers[csrfHeader] = csrfToken;
            }
            headers['Content-Type'] = 'application/json';

            Swal.fire({
                title: '처리 중...',
                html: '<i class="fas fa-spinner fa-spin me-2"></i>결제 취소를 처리하고 있습니다.',
                allowOutsideClick: false,
                allowEscapeKey: false,
                allowEnterKey: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            $.ajax({
                url: '/orders/payment/cancel/' + paymentIdx,
                type: 'POST',
                headers: headers,
                success: function(response) {
                    console.log('결제 취소 응답:', response);
                    if (response.success) {
                        // 예약도 취소하는 기능 추가
                        if (orderId && orderId.startsWith('ROOM_')) {
                            deleteReservation(paymentIdx);
                        } else {
                            Swal.fire({
                                icon: 'success',
                                title: '결제 취소 완료',
                                html: response.message,
                                showConfirmButton: true,
                                confirmButtonText: '확인',
                                allowOutsideClick: false
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    window.location.href = '/res/list';
                                }
                            });
                        }
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: '결제 취소 실패',
                            html: response.message || '결제 취소 중 오류가 발생했습니다.',
                            confirmButtonText: '확인'
                        });
                    }
                },
                error: function(xhr, status, error) {
                    console.error('결제 취소 오류:', xhr.responseJSON);
                    let errorMessage = '결제 취소 중 오류가 발생했습니다.';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    Swal.fire({
                        icon: 'error',
                        title: '결제 취소 실패',
                        html: errorMessage,
                        confirmButtonText: '확인'
                    });
                }
            });
        }

        function deleteReservation(paymentIdx) {
            // 예약 삭제 API 요청
            $.ajax({
                url: '/res/delete/' + paymentIdx,
                type: 'POST',
                headers: {
                    [csrfHeader]: csrfToken
                },
                success: function(response) {
                    Swal.fire({
                        icon: 'success',
                        title: '예약이 취소되었습니다.',
                        text: response.message,
                        confirmButtonText: '확인'
                    }).then(() => {
                        window.location.href = '/res/list';
                    });
                },
                error: function(xhr, status, error) {
                    Swal.fire({
                        icon: 'error',
                        title: '예약 취소 실패',
                        text: '예약 취소 중 오류가 발생했습니다.',
                        confirmButtonText: '확인'
                    });
                }
            });
        }
        /*]]>*/
    </script>
</th:block>
</body>

</html>
